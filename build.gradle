plugins {
    id 'java'
    id 'application'
    id 'org.javamodularity.moduleplugin' version '1.8.12'
    id 'org.openjfx.javafxplugin' version '0.0.13'
    id 'org.beryx.jlink' version '2.25.0'
}

group = 'com.example'
version = '1.0.0'

repositories {
    mavenCentral()
    maven { url 'https://jitpack.io' }
}

// External variables
ext {
    junitVersion = '5.9.2'
}

// Java version toolchain
java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(22)
    }
}

// Java version
sourceCompatibility = JavaVersion.VERSION_17
targetCompatibility = JavaVersion.VERSION_17

// Encoding settings
tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

// Application settings
application {
    mainModule = 'com.example.main_screen'
    mainClass = 'com.example.main_screen.GameCatalogApp'
}

// JavaFX settings
javafx {
    version = '22'
    modules = ['javafx.controls', 'javafx.fxml']
}

// Project dependencies
dependencies {
    implementation 'org.kordamp.bootstrapfx:bootstrapfx-core:0.4.0'
    implementation 'com.fasterxml.jackson.core:jackson-core:2.18.2'
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.18.2'
    implementation 'com.fasterxml.jackson.core:jackson-annotations:2.18.2'

    // JUnit for testing
    testImplementation "org.junit.jupiter:junit-jupiter-api:${junitVersion}"
    testRuntimeOnly "org.junit.jupiter:junit-jupiter-engine:${junitVersion}"
}

// Use JUnit 5 platform for tests
test {
    useJUnitPlatform()
}

// JLink plugin settings
jlink {
    options = [
            '--strip-debug', '--compress', '2',
            '--no-header-files', '--no-man-pages',
            '--add-modules', 'ALL-MODULE-PATH'
    ]
    launcher {
        name = 'app'
    }

    // Force include specific resources in the final runtime image
    addOptions('--add-modules', 'java.base,java.desktop,javafx.controls,javafx.fxml,jdk.zipfs')
    addOptions('--bind-services')

    // MacOS-specific settings
    if (org.gradle.internal.os.OperatingSystem.current().isMacOsX()) {
        addOptions('--mac-sign')
    }

    // Merge Jackson libraries to prevent module conflicts
    forceMerge('jackson')

    // JPackage settings for installer creation
    jpackage {
        imageName = "GameCatalog"
        installerName = "GameCatalog"
        appVersion = "1.0.0"
        vendor = "YourCompany"

        // Windows-specific installer settings
        if (org.gradle.internal.os.OperatingSystem.current().isWindows()) {
            installerType = "exe"
            imageOptions = ['--win-shortcut', '--win-menu', '--win-dir-chooser', '--win-per-user-install']
        }

        // Resource directory
        resourceDir = file("$buildDir/resources/main")

        // Where the generated image will be stored
        imageOutputDir = file("$buildDir/jpackage")

        // Additional options
        imageOptions = ['--verbose']
    }
}

// A task to create a Windows package using jpackage
task packageWindows(type: Exec) {
    dependsOn('jlink')

    // Only run this task on Windows
    onlyIf { org.gradle.internal.os.OperatingSystem.current().isWindows() }

    workingDir = projectDir

    def jlinkOutput = file("$buildDir/image")

    // Command to execute
    commandLine = [
            'jpackage',
            '--type', 'app-image',
            '--name', 'GameCatalog',
            '--app-version', '1.0.0',
            '--vendor', 'YourCompany',
            '--module', "${application.mainModule}/${application.mainClass}",
            '--runtime-image', jlinkOutput,
            '--dest', "$buildDir/jpackage",
            '--win-shortcut',
            '--win-menu',
            '--win-dir-chooser',
            '--win-per-user-install'
    ]
}

// Settings for running the app
run {
    doFirst {
        jvmArgs = [
                '--module-path', classpath.asPath,
                '--add-modules', 'javafx.controls,javafx.fxml'
        ]
    }
}
